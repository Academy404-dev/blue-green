pipeline {
    agent any // Aseg√∫rate de tener un agente donde se pueda ejecutar Docker y kubectl

    environment {
        DOCKER_CREDENTIALS_ID = 'docker-hub' // ID de las credenciales en Jenkins
        REGISTRY_URL = 'https://registry.hub.docker.com'
    }

    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Obtener Git Commit ID') {
            steps {
                script {
                    gitcommit = sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
                }
            }
        }

        stage('Test Node.js') {
            steps {
                docker.image('node').inside {
                    sh '''
                        npm install --only=dev
                        npm test
                    '''
                }
            }
        }

        stage('Docker Build & Push') {
            steps {
                script {
                    docker.withRegistry(REGISTRY_URL, DOCKER_CREDENTIALS_ID) {
                        def nuestraapp = docker.build("norman404/eneroappnodes:${gitcommit}", ".")
                        nuestraapp.push()
                    }
                }
            }
        }
        stage('Update & Deploy') {
            steps {
                sh """
                    sed -i 's/<IMAGE_TAG>/${gitcommit}/g' Deployment.yaml
                    kubectl apply -f Deployment.yaml
                """
            }
        }
    }
}
